class ChatEngine{constructor(e,s,a,t,n,i){this.chatBox=$(`#${e}`),this.userEmail=a,this.userId=s,this.userName=t,this.userProfile=n,this.socket=io.connect(i,{transports:["websocket"],secure:!0,reconnect:!0,rejectUnauthorized:!1,query:{userId:this.userId}}),this.chatRooms=["Global"],this.userEmail&&this.connectionHandler()}connectionHandler(){let e=this;this.socket.on("connect",(function(){e.socket.emit("user_online",{user_id:e.userId})})),e.socket.on("connections",(function(e){$("#active-users").html('<i class="fa-solid fa-circle"></i> '+(e.count-1)+" Online")})),e.socket.on("update_status",(function(s){s.map&&s.map.forEach((function(s,a){let t=$(`#status-${s.userId}`);t.length>0&&s.userId!=e.userId&&("Active now"===s.status?(t.html('<i class="fa-solid fa-circle"></i> Active now'),$(`#message-icon-${s.userId}`).removeClass("remove"),$(`#circle-icon-${s.userId}`).addClass("remove"),$(`#last-message-time-${s.userId}`).addClass("remove")):s.moment?t.html("Active "+s.moment):t.html("offline"))}))})),$("#global-chat-btn").click((function(){e.socket.emit("join_global_room",{user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:e.userId,chatroom:"Global"}),u("Global Chat joined!","success"),$("#chat-messages-list-global").parent().find("#messages-loader").removeClass("hide-loader")})),e.socket.on("global_user_joined",(async function(s){const a=await fetch(`/api/v1/chat/global/${s.from_user}/all`),t=await a.json();$("#chat-messages-list-global").parent().find("#messages-loader").addClass("hide-loader"),0==$("#chat-messages-list-global").children().length&&t.data.chatRoom.messages.forEach((function(s){!function(s){let a=$("<li>");$("<img>");a.addClass("animate__animated  animate__fadeIn");let t="other-message animate__animated  animate__fadeIn";s.sender.email==e.userEmail?(t="self-message",a.append(`<div class="msg-content">\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n                            </div>`)):a.append(`<div class="msg-content">\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                \n                            </div>`);if($("#chat-messages-list-global li").length){let e=$("#chat-messages-list-global li:last-child");e.find("sub").html()==s.sender.name&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),a.css("margin-top","0px"))}a.append($("<sub>",{html:s.sender.name})),a.addClass(t),$("#chat-messages-list-global").append(a),$("#chat-message-input-global").val("")}(s)})),l()})),$(".friend").click((function(){let s=$(this).attr("id"),a=e.userId,t=s+a;e.socket.emit("join_private_room",{user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:a,to_user:s,chatroom:t}),document.getElementById("chat-user-id").value==s&&($(`#chat-messages-list-private-${s}`).children().remove(),$(`#chat-messages-list-private-${s}`).html('\n                    <p class="update-msg">Send hi ðŸ‘‹ to your friend!</p>\n                ')),$(`#chat-messages-list-private-${s}`).parent().find("#messages-loader").removeClass("hide-loader")})),e.socket.on("private_user_joined",(async function(s){const a=await fetch(`/api/v1/chat/private/${s.from_user}/${s.to_user}`),t=await a.json();$(`#chat-messages-list-private-${s.to_user}`).parent().find("#messages-loader").addClass("hide-loader"),$(`#chat-messages-list-private-${s.from_user}`).children().length<=1&&t.data.chatRoom.messages.forEach((function(s){!function(s){let a=document.getElementById("chat-user-id").value;if(a!=s.sender._id&&a!=s.receiver._id)return;let t=$("<li>");$("<img>");t.addClass("animate__animated  animate__fadeIn");let n="other-message animate__animated  animate__fadeIn";s.sender.email==e.userEmail?(n="self-message",t.append(`<div class="msg-content">\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n                                \n                            </div>`)):t.append(`<div class="msg-content">\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                \n                            </div>`);if($(`#chat-messages-list-private-${a} li`).length){let e=$(`#chat-messages-list-private-${a} li:last-child`);e.find("img").attr("src")==s.sender.avatar&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),t.css("margin-top","0px"))}t.addClass(n),$(`#chat-messages-list-private-${a}`).append(t),$("#chat-message-input-private").val("")}(s)})),c()})),$("#chat-message-input-private").keypress((function(s){const a=document.getElementById("chat-user-id").value,t=e.userId;let n=a+t;13!=s.which&&e.socket.emit("typingPrivate",{user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:t,to_user:a,chatroom:n})}));let s,a,t=!1;function n(){t=!1,$("#typing-status-private").addClass("animate__fadeOut"),a=setTimeout((function(){$("#typing-status-private").html("")}),700)}e.socket.on("typingResponsePrivate",(function(i){const o=document.getElementById("chat-user-id").value,r=e.userId;let m=o+r,l=r+o;if((i.chatroom==m||i.chatroom==l)&&i.from_user!==r)if(!1===t){clearTimeout(a),$("#typing-status-private").removeClass("animate__fadeOut"),t=!0;$("#typing-status-private").html(`\n                            <img class='animate__animated animate__fadeIn' src="${i.user_profile}">\n                            <div class="animation animate__animated animate__fadeIn">\n                                <div class="animation__dot1"></div>\n                                <div class="animation__dot2"></div>\n                                <div class="animation__dot3"></div>\n                            </div>\n                        `);s=setTimeout(n,1e3)}else clearTimeout(s),s=setTimeout(n,1e3)})),$("#chat-message-input-global").keypress((function(s){const a=e.userId;13!=s.which&&e.socket.emit("typingGlobal",{user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:a,chatroom:"Global"})}));let i,o,r=!1;function m(){r=!1,$("#typing-status-global").addClass("animate__fadeOut"),o=setTimeout((function(){$("#typing-status-global").html("")}),700)}function l(){let e=document.getElementById("chat-messages-list-global");e.scrollTop=e.scrollHeight}function c(){let e=document.getElementById("chat-user-id").value,s=document.getElementById("chat-messages-list-private-"+e);s.scrollTop=s.scrollHeight}function u(e,s,a,t){"error"==s?(t||(t="https://cdn-icons-png.flaticon.com/512/1160/1160303.png?w=1480&t=st=1680445542~exp=1680446142~hmac=c9f4eeb27a966c0a92628d64cc93b6d47b8b8d4d2834ba1930357bf0bf47c1e9"),Toastify({text:"<%= flash.error %>",duration:a,destination:"",newWindow:!0,close:!0,avatar:t,gravity:"top",position:"center",stopOnFocus:!0,style:{background:"#D20A0A",borderRadius:"10px",color:"white"},onClick:function(){}}).showToast()):"success"==s&&(t||(t="https://cdn-icons-png.flaticon.com/512/845/845646.png?w=1480&t=st=1680445326~exp=1680445926~hmac=0cb88a0841456c7c4b22ff6c8b911a3acb1e1278095990a5368ab134203fb03d"),Toastify({text:e,duration:a,destination:"",newWindow:!0,close:!0,avatar:t,gravity:"top",position:"center",stopOnFocus:!0,style:{background:"#202020",borderRadius:"10px"},onClick:function(){}}).showToast())}e.socket.on("typingResponseGlobal",(function(s){const a=e.userId;if("Global"==s.chatroom&&s.from_user!==a)if(!1===r){clearTimeout(o),$("#typing-status-global").removeClass("animate__fadeOut"),r=!0;const e=$("#typing-status-global").html(`\n                            <img class='animate__animated animate__fadeIn' src="${s.user_profile}">\n                            <div class="animation animate__animated animate__fadeIn">\n                                <div class="animation__dot1"></div>\n                                <div class="animation__dot2"></div>\n                                <div class="animation__dot3"></div>\n                            </div>\n                        `);$("#chat-messages-list-global").append(e),i=setTimeout(m,1e3)}else clearTimeout(i),i=setTimeout(m,1e3)})),$("#send-message-global").click((function(){let s=$("#chat-message-input-global").val();if(""!=s){if("Global Chat"==document.getElementById("chat-room-").innerText){e.socket.emit("send_global_message",{message:s,user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:e.userId,chatroom:"Global"});fetch(`/api/v1/chat/createmessage/${s}/${e.userId}/all`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}}).then((function(e){return e.json()})).then((function(e){})).catch((function(e){showToast("error","Error sending message!",3e3,"")}))}}})),$("#send-message-private").click((function(){let s=$("#chat-message-input-private").val();if(""!=s){const a=document.getElementById("chat-user-id").value,t=e.userId;let n=a+t;e.socket.emit("send_private_message",{message:s,user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:t,to_user:a,chatroom:n});fetch(`/api/v1/chat/createmessage/${s}/${t}/${a}`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}}).then((function(e){return e.json()})).then((function(e){})).catch((function(e){showToast("error","Error sending message!",3e3,"")}))}})),$("#chat-message-input-global").keypress((function(e){13==e.which&&$("#send-message-global").click()})),$("#chat-message-input-private").keypress((function(e){13==e.which&&$("#send-message-private").click()})),e.socket.on("receive_notification",(function(s){$("#user-messages-private").hasClass("remove")&&e.userId==s.to_user&&u("New message from "+s.user_name.split(" ")[0],"success",4e3,"https://img.freepik.com/free-icon/chat_318-561856.jpg?size=626&ext=jpg&uid=R38501345&ga=GA1.2.1154692012.1676455794&semt=ais")})),e.socket.on("receive_global_message",(function(s){let a=$("<li>");$("<img>");a.addClass("animate__animated  animate__fadeIn");let t="other-message animate__animated  animate__fadeIn";if(s.user_email==e.userEmail?(t="self-message",a.append(`<div class="msg-content">\n                                <span>\n                                    ${s.message} <sup>${s.time}</sup> \n                                </span>\n                                <img src="${s.user_profile}">\n                            </div>`)):a.append(`<div class="msg-content">\n                                <img src="${s.user_profile}">\n                                <span>\n                                    ${s.message} <sup>${s.time}</sup> \n                                </span>\n                                \n                            </div>`),$("#chat-messages-list-global li").length){let e=$("#chat-messages-list-global li:last-child");e.find("sub").html()==s.user_name&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),a.css("margin-top","0px"))}a.append($("<sub>",{html:s.user_name})),a.addClass(t),$("#chat-messages-list-global").append(a),$("#chat-message-input-global").val(""),l()})),e.socket.on("receive_private_message",(function(s){let a=document.getElementById("chat-user-id").value;if(a!=s.from_user&&a!=s.to_user)return;let t=$("<li>");$("<img>");t.addClass("animate__animated  animate__fadeIn");let n="other-message animate__animated  animate__fadeIn";if(s.user_email==e.userEmail?(n="self-message",t.append(`<div class="msg-content">\n                                <span>\n                                    ${s.message} <sup>${s.time}</sup> \n                                </span>\n                                <img src="${s.user_profile}">\n                            </div>`)):t.append(`<div class="msg-content">\n                                <img src="${s.user_profile}">\n                                <span>\n                                    ${s.message} <sup>${s.time}</sup> \n                                </span>\n                                \n                            </div>`),$(`#chat-messages-list-private-${a} li`).length){let e=$(`#chat-messages-list-private-${a} li:last-child`);e.find("img").attr("src")==s.user_profile&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),t.css("margin-top","0px"))}t.addClass(n),$(`#chat-messages-list-private-${a}`).append(t),$("#chat-message-input-private").val(""),c()}))}}