class ChatEngine{constructor(e,s,a,t,n,i){this.chatBox=$(`#${e}`),this.userEmail=a,this.userId=s,this.userName=t,this.userProfile=n,this.socket=io.connect(i,{transports:["websocket"],secure:!0,reconnect:!0,rejectUnauthorized:!1,query:{userId:this.userId}}),this.chatRooms=["Global"],this.userEmail&&this.connectionHandler()}connectionHandler(){let e=this;function s(){let e=document.getElementById("chat-messages-list-global");e.scrollTop=e.scrollHeight}function a(){let e=document.getElementById("chat-user-id").value,s=document.getElementById("chat-messages-list-private-"+e);s.scrollTop=s.scrollHeight}function t(e,s,a,t){"error"==s?(t||(t="https://cdn-icons-png.flaticon.com/512/1160/1160303.png?w=1480&t=st=1680445542~exp=1680446142~hmac=c9f4eeb27a966c0a92628d64cc93b6d47b8b8d4d2834ba1930357bf0bf47c1e9"),Toastify({text:"<%= flash.error %>",duration:a,destination:"",newWindow:!0,close:!0,avatar:t,gravity:"top",position:"center",stopOnFocus:!0,style:{background:"#D20A0A",borderRadius:"10px",color:"white"},onClick:function(){}}).showToast()):"success"==s&&(t||(t="https://cdn-icons-png.flaticon.com/512/845/845646.png?w=1480&t=st=1680445326~exp=1680445926~hmac=0cb88a0841456c7c4b22ff6c8b911a3acb1e1278095990a5368ab134203fb03d"),Toastify({text:e,duration:a,destination:"",newWindow:!0,close:!0,avatar:t,gravity:"top",position:"center",stopOnFocus:!0,style:{background:"#202020",borderRadius:"10px"},onClick:function(){}}).showToast())}this.socket.on("connect",(function(){e.socket.emit("user_online",{user_id:e.userId})})),e.socket.on("connections",(function(e){$("#active-users").html('<i class="fa-solid fa-circle"></i> '+(e.count-1)+" Online")})),e.socket.on("update_status",(function(e){e.map&&e.map.forEach((function(e,s){let a=$(`#status-${e.userId}`);"online"===e.status&&a.length>0?a.html('<i class="fa-solid fa-circle"></i> Active Now'):a.length>0&&(e.moment?a.html("Active "+e.moment):a.html("offline"))}))})),$("#global-chat-btn").click((function(){e.socket.emit("join_global_room",{user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:e.userId,chatroom:"Global"}),t("Global Chat joined!","success"),$("#chat-messages-list-global").parent().find("#messages-loader").removeClass("hide-loader")})),e.socket.on("global_user_joined",(async function(a){const t=await fetch(`/api/v1/chat/global/${a.from_user}/all`),n=await t.json();$("#chat-messages-list-global").parent().find("#messages-loader").addClass("hide-loader"),0==$("#chat-messages-list-global").children().length&&n.data.chatRoom.messages.forEach((function(s){!function(s){let a=$("<li>");$("<img>");a.addClass("animate__animated  animate__fadeIn");let t="other-message animate__animated  animate__fadeIn";s.sender.email==e.userEmail?(t="self-message",a.append(`<div class="msg-content">\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n                            </div>`)):a.append(`<div class="msg-content">\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                \n                            </div>`);if($("#chat-messages-list-global li").length){let e=$("#chat-messages-list-global li:last-child");e.find("sub").html()==s.sender.name&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),a.css("margin-top","0px"))}a.append($("<sub>",{html:s.sender.name})),a.addClass(t),$("#chat-messages-list-global").append(a),$("#chat-message-input-global").val("")}(s)})),s()})),$(".friend").click((function(){let s=$(this).attr("id"),a=e.userId,t=s+a;e.socket.emit("join_private_room",{user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:a,to_user:s,chatroom:t}),document.getElementById("chat-user-id").value==s&&$(`#chat-messages-list-private-${s}`).children().remove(),$(`#chat-messages-list-private-${s}`).parent().find("#messages-loader").removeClass("hide-loader")})),e.socket.on("private_user_joined",(async function(s){const t=await fetch(`/api/v1/chat/private/${s.from_user}/${s.to_user}`),n=await t.json();$(`#chat-messages-list-private-${s.to_user}`).parent().find("#messages-loader").addClass("hide-loader"),0==$(`#chat-messages-list-private-${s.from_user}`).children().length&&n.data.chatRoom.messages.forEach((function(s){!function(s){let a=document.getElementById("chat-user-id").value;if(a!=s.sender._id&&a!=s.receiver._id)return;let t=$("<li>");$("<img>");t.addClass("animate__animated  animate__fadeIn");let n="other-message animate__animated  animate__fadeIn";s.sender.email==e.userEmail?(n="self-message",t.append(`<div class="msg-content">\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n                                \n                            </div>`)):t.append(`<div class="msg-content">\n                                <img src="${s.sender.avatar?s.sender.avatar:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460__340.png"}">\n                                <span>\n                                    ${s.message} <sup>${new Date(s.createdAt).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"})}</sup> \n                                </span>\n                                \n                            </div>`);if($(`#chat-messages-list-private-${a} li`).length){let e=$(`#chat-messages-list-private-${a} li:last-child`);e.find("sub").html()==s.sender.name&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),t.css("margin-top","0px"))}t.append($("<sub>",{html:s.sender.name})),t.addClass(n),$(`#chat-messages-list-private-${a}`).append(t),$("#chat-message-input-private").val("")}(s)})),a()})),$("#send-message-global").click((function(){let s=$("#chat-message-input-global").val();if(""!=s){if("Global Chat"==document.getElementById("chat-room-").innerText){e.socket.emit("send_global_message",{message:s,user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:e.userId,chatroom:"Global"});fetch(`/api/v1/chat/createmessage/${s}/${e.userId}/all`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}}).then((function(e){return e.json()})).then((function(e){})).catch((function(e){showToast("error","Error sending message!",3e3,"")}))}}})),$("#send-message-private").click((function(){let s=$("#chat-message-input-private").val();if(""!=s){const a=document.getElementById("chat-user-id").value,t=e.userId;let n=a+t;e.socket.emit("send_private_message",{message:s,user_email:e.userEmail,user_name:e.userName,user_profile:e.userProfile,time:(new Date).toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"numeric"}),from_user:t,to_user:a,chatroom:n});fetch(`/api/v1/chat/createmessage/${s}/${t}/${a}`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}}).then((function(e){return e.json()})).then((function(e){})).catch((function(e){showToast("error","Error sending message!",3e3,"")}))}})),$("#chat-message-input-global").keypress((function(e){13==e.which&&$("#send-message-global").click()})),$("#chat-message-input-private").keypress((function(e){13==e.which&&$("#send-message-private").click()})),e.socket.on("receive_notification",(function(s){$("#user-messages-private").hasClass("remove")&&e.userId==s.to_user&&t("New message from "+s.user_name.split(" ")[0],"success",4e3,"https://img.freepik.com/free-icon/chat_318-561856.jpg?size=626&ext=jpg&uid=R38501345&ga=GA1.2.1154692012.1676455794&semt=ais")})),e.socket.on("receive_global_message",(function(a){let t=$("<li>");$("<img>");t.addClass("animate__animated  animate__fadeIn");let n="other-message animate__animated  animate__fadeIn";if(a.user_email==e.userEmail?(n="self-message",t.append(`<div class="msg-content">\n                                <span>\n                                    ${a.message} <sup>${a.time}</sup> \n                                </span>\n                                <img src="${a.user_profile}">\n                            </div>`)):t.append(`<div class="msg-content">\n                                <img src="${a.user_profile}">\n                                <span>\n                                    ${a.message} <sup>${a.time}</sup> \n                                </span>\n                                \n                            </div>`),$("#chat-messages-list-global li").length){let e=$("#chat-messages-list-global li:last-child");e.find("sub").html()==a.user_name&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),t.css("margin-top","0px"))}t.append($("<sub>",{html:a.user_name})),t.addClass(n),$("#chat-messages-list-global").append(t),$("#chat-message-input-global").val(""),s()})),e.socket.on("receive_private_message",(function(s){let t=document.getElementById("chat-user-id").value;if(t!=s.from_user&&t!=s.to_user)return;let n=$("<li>");$("<img>");n.addClass("animate__animated  animate__fadeIn");let i="other-message animate__animated  animate__fadeIn";if(s.user_email==e.userEmail?(i="self-message",n.append(`<div class="msg-content">\n                                <span>\n                                    ${s.message} <sup>${s.time}</sup> \n                                </span>\n                                <img src="${s.user_profile}">\n                            </div>`)):n.append(`<div class="msg-content">\n                                <img src="${s.user_profile}">\n                                <span>\n                                    ${s.message} <sup>${s.time}</sup> \n                                </span>\n                                \n                            </div>`),$(`#chat-messages-list-private-${t} li`).length){let e=$(`#chat-messages-list-private-${t} li:last-child`);e.find("sub").html()==s.user_name&&(e.find("sub").remove(),e.find("img").css("visibility","hidden"),e.hasClass("self-message"),e.css("margin-bottom","0px"),n.css("margin-top","0px"))}n.append($("<sub>",{html:s.user_name})),n.addClass(i),$(`#chat-messages-list-private-${t}`).append(n),$("#chat-message-input-private").val(""),a()}))}}